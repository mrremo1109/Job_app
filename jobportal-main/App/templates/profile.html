{% extends 'base.html' %}

{% block title %}Profile{% endblock %}

{% block data %}
<div class="container">
    <h1>PROFILE</h1>
    <div class="row">
        <div class="col-md-6">
            {% if profile %}
                <h2>DETAILS</h2>
                <p><strong>Name:</strong> {{ profile.user.first_name }} {{ profile.user.last_name }}</p>
                <p><strong>Email:</strong> {{ profile.user.email }}</p>
                <p><strong>Phone:</strong> {{ profile.phone }}</p>
                {% if profile.address %}
                    <p><strong>Address:</strong> {{ profile.address }}</p>
                {% endif %}
                {% if profile.resume %}
                    <p><strong>Resume:</strong> <a href="{{ profile.resume.url }}" download>Download</a></p>
                {% endif %}
                {% if profile_type == 'recruiter' %}
                    <p><strong>Company:</strong> {{ profile.company }}</p>
                {% endif %}
                <p><strong>Number of 
                    {% if profile_type == 'job_seeker' %}
                        Applied Posts
                    {% else %}
                        Applications
                    {% endif %}
                :</strong> {{ applied_posts|length }}</p>
                <a href="{% url 'logoutUser' %}" class="btn btn-danger mt-3">Logout</a>
                <a href="{% url 'edit_profile' %}" class="btn btn-primary mt-3">Edit Profile</a>

                <!-- Open Chat Button -->
                <a href="http://localhost:3000" class="btn btn-success mt-3">Open Chat</a>
                
                <!-- Chat iframe -->
                <div class="col-md-12 mt-4">
                    <h2>Chat</h2>
                    <iframe src="http://localhost:3000" style="width:100%; height:500px; border:none;"></iframe>
                </div> 
            {% endif %}
        </div>

        <div class="col-md-6">
            {% if profile_type == 'job_seeker' %}
                <h2>Applied Posts</h2>
                <div class="list-group">
                    {% for post in applied_posts %}
                        <div class="list-group-item">
                            <h5>{{ post.job.post }}</h5>
                            <p><strong>Employer:</strong> {{ post.job.user.company }}</p>
                            <p><strong>Status:</strong> {{ post.status }}</p>
                        </div>
                    {% empty %}
                        <p>No posts applied yet.</p>
                    {% endfor %}
                </div>
            {% elif profile_type == 'recruiter' %}
                <h2>APPLICATIONS</h2>
                <div class="list-group">
                    {% for application in applied_posts %}
                        <div class="list-group-item">
                            <h5>Applicant: {{ application.applied_by.user.first_name }} {{ application.applied_by.user.last_name }}</h5>
                            <p><strong>Email:</strong> {{ application.applied_by.user.email }}</p>
                            <p><strong>Phone:</strong> {{ application.applied_by.phone }}</p>
                            {% if application.applied_by.resume %}
                                <p><strong>Resume:</strong> <a href="{{ application.applied_by.resume.url }}" download>Download</a></p>
                            {% endif %}
                            <p><strong>Job:</strong> {{ application.job.post }}</p>
                            <p><strong>Status:</strong>
                                <form method="post" action="{% url 'update_application_status' application.id %}">
                                    {% csrf_token %}
                                    <select name="status" class="form-control">
                                        <option value="reviewing" {% if application.status == 'reviewing' %}selected{% endif %}>Reviewing</option>
                                        <option value="selected" {% if application.status == 'selected' %}selected{% endif %}>Selected</option>
                                        <option value="rejected" {% if application.status == 'rejected' %}selected{% endif %}>Rejected</option>
                                    </select>
                                    <button type="submit" class="btn btn-primary mt-2">Update</button>
                                </form>
                            </p>
                        </div>
                    {% empty %}
                        <p>No applications yet.</p>
                    {% endfor %}
                </div>
            {% endif %}
        </div>
    </div>

    {% if profile_type == 'recruiter' %}
    <div class="row mt-3">
        <div class="col-md-12">
            <div id="map" style="height: 400px;"></div>
        </div>
    </div>
    {% endif %}
</div>

{% if profile_type == 'recruiter' %}
<script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=places"></script>
<script>
    function initMap() {
        const latitude = {{ profile.latitude|default:"0" }};
        const longitude = {{ profile.longitude|default:"0" }};
        const map = new google.maps.Map(document.getElementById('map'), {
            zoom: 14,
            center: { lat: latitude, lng: longitude }
        });
        const marker = new google.maps.Marker({
            position: { lat: latitude, lng: longitude },
            map: map
        });
    }
    google.maps.event.addDomListener(window, 'load', initMap);
</script>
{% endif %}
{% endblock %}
